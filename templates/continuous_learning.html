{% extends "base.html" %}

{% block title %}Continuous Learning - FarmBOT{% endblock %}

{% block content %}
<style>
    .learning-card {
        border-left: 4px solid #28a745;
    }
    .feedback-section {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin: 20px 0;
    }
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin: 20px 0;
    }
    .stat-card {
        background: white;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        text-align: center;
    }
    .stat-number {
        font-size: 2em;
        font-weight: bold;
        color: #28a745;
    }
    .stat-number.text-warning {
        color: #ffc107;
    }
    .feedback-form {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin: 20px 0;
    }
</style>

<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-brain"></i> Continuous Learning System
        </h1>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card learning-card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-sync-alt"></i> Automatically improve your model using uploaded test images
                </h5>
            </div>
            <div class="card-body">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i>
                                <strong>How it works:</strong> When you test images through the web interface, 
                                they are automatically saved for continuous learning. You can provide feedback 
                                on incorrect predictions to help the model learn and improve.
                            </div>

                            <!-- Learning Statistics -->
                            <div class="row">
                                <div class="col-md-8">
                                    <h5><i class="fas fa-chart-bar"></i> Learning Statistics</h5>
                                    <div class="stats-grid" id="learningStats">
                                        <div class="stat-card">
                                            <div class="stat-number" id="totalFeedback">0</div>
                                            <div>Total Feedback</div>
                                        </div>
                                        <div class="stat-card">
                                            <div class="stat-number" id="incorrectPredictions">0</div>
                                            <div>Incorrect Predictions</div>
                                        </div>
                                        <div class="stat-card">
                                            <div class="stat-number" id="learningImages">0</div>
                                            <div>Learning Images</div>
                                        </div>
                                        <div class="stat-card">
                                            <div class="stat-number" id="retrainingNeeded">No</div>
                                            <div>Retraining Status</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-primary" onclick="loadLearningStats()">
                                            <i class="fas fa-refresh"></i> Refresh Stats
                                        </button>
                                        <button class="btn btn-success" onclick="triggerRetraining()">
                                            <i class="fas fa-cogs"></i> Retrain Model
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Feedback Section -->
                            <div class="feedback-section" id="feedbackSection">
                                <h5><i class="fas fa-comment-dots"></i> Provide Feedback</h5>
                                <p class="mb-2">
                                    <i class="fas fa-info-circle text-info"></i> 
                                    <strong>Tip:</strong> Click on any recent image above to automatically fill the form. 
                                    Then just select the correct class and submit!
                                </p>
                                <p class="text-muted small mb-3">If a prediction was incorrect, help the model learn by providing the correct classification:</p>
                                
                                <form id="feedbackForm">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="imagePath" class="form-label">Image Path</label>
                                                <input type="text" class="form-control" id="imagePath" 
                                                       placeholder="Path to the test image" required>
                                            </div>
                                            <div class="mb-3">
                                                <label for="predictedClass" class="form-label">Predicted Class</label>
                                                <select class="form-select" id="predictedClass" required>
                                                    <option value="">Select predicted class</option>
                                                    <option value="not_ready">Not Ready (Unripe)</option>
                                                    <option value="ready">Ready (Ripe)</option>
                                                    <option value="spoilt">Spoilt (Old/Damaged)</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="correctClass" class="form-label">Correct Class</label>
                                                <select class="form-select" id="correctClass" required>
                                                    <option value="">Select correct class</option>
                                                    <option value="not_ready">Not Ready (Unripe)</option>
                                                    <option value="ready">Ready (Ripe)</option>
                                                    <option value="spoilt">Spoilt (Old/Damaged)</option>
                                                </select>
                                            </div>
                                            <div class="mb-3">
                                                <label for="confidence" class="form-label">Prediction Confidence</label>
                                                <input type="number" class="form-control" id="confidence" 
                                                       min="0" max="1" step="0.01" placeholder="0.85" required>
                                            </div>
                                        </div>
                                    </div>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save"></i> Submit Feedback
                                    </button>
                                </form>
                            </div>

                            <!-- Recent Test Images -->
                            <div class="card mt-4">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0"><i class="fas fa-images"></i> Recent Test Images</h5>
                                    <div class="btn-group" role="group">
                                        <button class="btn btn-sm btn-outline-primary" onclick="loadRecentImages()">
                                            <i class="fas fa-refresh"></i> Refresh
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="confirmDeleteAllImages()" title="Delete all recent images">
                                            <i class="fas fa-trash-alt"></i> Clear All
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div id="recentImages">
                                        <p class="text-muted">Loading recent images...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
        // Load learning statistics
        function loadLearningStats() {
            fetch('/learning_stats')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.stats) {
                        document.getElementById('totalFeedback').textContent = data.stats.total_feedback || 0;
                        document.getElementById('incorrectPredictions').textContent = data.stats.incorrect_predictions || 0;
                        document.getElementById('learningImages').textContent = data.stats.learning_images || 0;
                        const retrainingStatus = data.stats.retraining_needed || 'No';
                        document.getElementById('retrainingNeeded').textContent = retrainingStatus;
                        document.getElementById('retrainingNeeded').className = retrainingStatus === 'Yes' ? 'stat-number text-warning' : 'stat-number';
                    } else {
                        console.error('Failed to load stats:', data.error || 'Unknown error');
                    }
                })
                .catch(error => {
                    console.error('Error loading stats:', error);
                });
        }

        // Submit feedback
        document.getElementById('feedbackForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const feedbackData = {
                image_path: document.getElementById('imagePath').value,
                predicted_class: document.getElementById('predictedClass').value,
                correct_class: document.getElementById('correctClass').value,
                confidence: parseFloat(document.getElementById('confidence').value)
            };
            
            fetch('/feedback', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(feedbackData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Feedback submitted successfully!');
                    document.getElementById('feedbackForm').reset();
                    loadLearningStats();
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error submitting feedback');
            });
        });

        // Trigger retraining
        function triggerRetraining() {
            if (confirm('Are you sure you want to prepare the model for retraining? This will organize feedback data into a training dataset.')) {
                const btn = event.target;
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Preparing...';
                
                fetch('/retrain_model', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-cogs"></i> Retrain Model';
                    
                    if (data.success) {
                        alert(`Dataset prepared successfully!\n\nImages copied: ${data.images_copied || 0}\nDataset path: ${data.dataset_path || 'N/A'}\n\nYou can now use this dataset to retrain your model.`);
                        loadLearningStats();
                    } else {
                        alert('Error: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(error => {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-cogs"></i> Retrain Model';
                    console.error('Error:', error);
                    alert('Error starting retraining: ' + error.message);
                });
            }
        }

        // Populate feedback form from image data
        function populateFeedbackForm(imagePath, predictedClass, confidence) {
            // Fill in the form fields
            document.getElementById('imagePath').value = imagePath;
            
            if (predictedClass) {
                // Map class names to form values
                const classMap = {
                    'not_ready': 'not_ready',
                    'not ready': 'not_ready',
                    'unripe': 'not_ready',
                    'ready': 'ready',
                    'ripe': 'ready',
                    'spoilt': 'spoilt',
                    'spoiled': 'spoilt',
                    'old': 'spoilt',
                    'damaged': 'spoilt'
                };
                
                const mappedClass = classMap[predictedClass.toLowerCase()] || predictedClass.toLowerCase();
                document.getElementById('predictedClass').value = mappedClass;
            }
            
            if (confidence !== undefined && confidence !== null && confidence > 0) {
                document.getElementById('confidence').value = confidence.toFixed(2);
            }
            
            // Clear correct class (user needs to select this)
            document.getElementById('correctClass').value = '';
            
            // Scroll to feedback form
            const feedbackSection = document.getElementById('feedbackSection');
            feedbackSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            
            // Highlight the form briefly
            const form = document.getElementById('feedbackForm');
            form.style.transition = 'box-shadow 0.3s ease, border 0.3s ease';
            form.style.boxShadow = '0 0 20px rgba(40, 167, 69, 0.6)';
            form.style.border = '2px solid #28a745';
            setTimeout(() => {
                form.style.boxShadow = '';
                form.style.border = '';
            }, 2000);
            
            // Show a brief notification
            const notification = document.createElement('div');
            notification.className = 'alert alert-success alert-dismissible fade show position-fixed';
            notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            notification.innerHTML = `
                <i class="fas fa-check-circle"></i> <strong>Form filled!</strong> Image path and prediction added. Please select the correct class and submit.
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.remove();
            }, 4000);
        }

        // Load recent images
        function loadRecentImages() {
            const container = document.getElementById('recentImages');
            container.innerHTML = '<p class="text-muted">Loading...</p>';
            
            fetch('/recent_learning_images')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.images && data.images.length > 0) {
                        let html = '<div class="row">';
                        data.images.forEach(img => {
                            // Extract relative path from learning_data directory
                            let relativePath = img.path.replace(/\\/g, '/');
                            if (relativePath.startsWith('learning_data/')) {
                                relativePath = relativePath.substring('learning_data/'.length);
                            }
                            const imgUrl = `/learning_image/${relativePath}`;
                            
                            // Get prediction info if available
                            const predictedClass = img.predicted_class || '';
                            const confidence = (img.confidence !== undefined && img.confidence !== null) ? img.confidence : 0;
                            const hasPrediction = predictedClass && confidence > 0;
                            
                            // Escape path for onclick
                            const escapedPath = img.path.replace(/'/g, "\\'");
                            
                            html += `
                                <div class="col-md-3 mb-3" id="image-card-${img.name.replace(/[^a-zA-Z0-9]/g, '_')}">
                                    <div class="card" style="transition: transform 0.2s;" 
                                         onmouseover="this.style.transform='scale(1.05)'" 
                                         onmouseout="this.style.transform='scale(1)'">
                                        <div style="position: relative;">
                                            <img src="${imgUrl}" class="card-img-top" style="height: 150px; object-fit: cover; width: 100%; cursor: pointer;" 
                                                 alt="${img.name}" 
                                                 onclick="populateFeedbackForm('${escapedPath}', '${predictedClass}', ${confidence})"
                                                 onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'200\' height=\'150\'%3E%3Crect fill=\'%23ddd\' width=\'200\' height=\'150\'/%3E%3Ctext fill=\'%23999\' font-family=\'sans-serif\' font-size=\'14\' x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dy=\'.3em\'%3EImage%3C/text%3E%3C/svg%3E'">
                                            <div style="position: absolute; top: 5px; right: 5px; display: flex; gap: 3px;">
                                                <div style="background: rgba(0,0,0,0.6); color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.7rem; cursor: pointer;" 
                                                     onclick="event.stopPropagation(); window.open('${imgUrl}', '_blank')" 
                                                     title="View full image">
                                                    <i class="fas fa-expand"></i>
                                                </div>
                                                <div style="background: rgba(220,53,69,0.8); color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.7rem; cursor: pointer;" 
                                                     onclick="event.stopPropagation(); deleteLearningImage('${escapedPath}', '${img.name.replace(/'/g, "\\'")}')" 
                                                     title="Delete image">
                                                    <i class="fas fa-trash"></i>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="card-body p-2">
                                            <small class="text-muted d-block" style="font-size: 0.75rem;" title="${img.path}">${img.name}</small>
                                            ${hasPrediction ? `
                                                <small class="badge bg-info" style="font-size: 0.65rem;">
                                                    ${predictedClass} (${(confidence * 100).toFixed(0)}%)
                                                </small>
                                            ` : ''}
                                            <small class="text-muted d-block" style="font-size: 0.7rem;">${img.date}</small>
                                            <small class="text-primary d-block mt-1" style="font-size: 0.7rem;">
                                                <i class="fas fa-hand-pointer"></i> Click image to add feedback
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        html += '</div>';
                        container.innerHTML = html;
                    } else {
                        container.innerHTML = '<p class="text-muted">No recent test images found.</p>';
                    }
                })
                .catch(error => {
                    console.error('Error loading images:', error);
                    container.innerHTML = '<p class="text-danger">Error loading images.</p>';
                });
        }

        // Delete a learning image
        function deleteLearningImage(imagePath, imageName) {
            if (!confirm(`Are you sure you want to delete "${imageName}"?\n\nThis will permanently remove the image and its metadata.`)) {
                return;
            }
            
            fetch('/delete_learning_image', {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ image_path: imagePath })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show success notification
                    const notification = document.createElement('div');
                    notification.className = 'alert alert-success alert-dismissible fade show position-fixed';
                    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
                    notification.innerHTML = `
                        <i class="fas fa-check-circle"></i> <strong>Deleted!</strong> Image removed successfully.
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    document.body.appendChild(notification);
                    setTimeout(() => notification.remove(), 3000);
                    
                    // Reload images
                    loadRecentImages();
                    // Update stats
                    loadLearningStats();
                } else {
                    alert('Error: ' + (data.error || 'Failed to delete image'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error deleting image: ' + error.message);
            });
        }

        // Delete all recent images
        function confirmDeleteAllImages() {
            if (!confirm('Are you sure you want to delete ALL recent test images?\n\nThis action cannot be undone and will remove all images and their metadata.')) {
                return;
            }
            
            // Get all images first
            fetch('/recent_learning_images')
                .then(response => response.json())
                .then(data => {
                    if (!data.success || !data.images || data.images.length === 0) {
                        alert('No images to delete.');
                        return;
                    }
                    
                    if (!confirm(`This will delete ${data.images.length} image(s). Continue?`)) {
                        return;
                    }
                    
                    // Delete all images
                    let deleted = 0;
                    let failed = 0;
                    const total = data.images.length;
                    
                    data.images.forEach((img, index) => {
                        fetch('/delete_learning_image', {
                            method: 'DELETE',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ image_path: img.path })
                        })
                        .then(response => response.json())
                        .then(result => {
                            if (result.success) {
                                deleted++;
                            } else {
                                failed++;
                            }
                            
                            // Check if all deletions are complete
                            if (deleted + failed === total) {
                                const message = failed > 0 
                                    ? `Deleted ${deleted} of ${total} images. ${failed} failed.`
                                    : `Successfully deleted all ${deleted} images!`;
                                
                                alert(message);
                                loadRecentImages();
                                loadLearningStats();
                            }
                        })
                        .catch(error => {
                            failed++;
                            if (deleted + failed === total) {
                                alert(`Deleted ${deleted} of ${total} images. ${failed} failed.`);
                                loadRecentImages();
                                loadLearningStats();
                            }
                        });
                    });
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error loading images: ' + error.message);
                });
        }

        // Load stats on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadLearningStats();
            loadRecentImages();
        });
</script>
{% endblock %}
