{% extends "base.html" %}

{% block title %}Continuous Learning - FarmBOT{% endblock %}

{% block content %}
<style>
    .learning-card {
        border-left: 4px solid #28a745;
    }
    .feedback-section {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin: 20px 0;
    }
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin: 20px 0;
    }
    .stat-card {
        background: white;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        text-align: center;
    }
    .stat-number {
        font-size: 2em;
        font-weight: bold;
        color: #28a745;
    }
    .stat-number.text-warning {
        color: #ffc107;
    }
    .feedback-form {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin: 20px 0;
    }
    .terminal-style {
        background: #1e1e1e !important;
        color: #d4d4d4 !important;
        font-family: 'Courier New', 'Consolas', 'Monaco', monospace !important;
    }
    .log-line {
        margin: 2px 0;
        padding: 2px 0;
        word-wrap: break-word;
        white-space: pre-wrap;
    }
    .log-line:contains("‚úÖ") { color: #4ec9b0; }
    .log-line:contains("‚ùå") { color: #f48771; }
    .log-line:contains("‚ö†Ô∏è") { color: #dcdcaa; }
    .log-line:contains("üìä") { color: #569cd6; }
    .log-line:contains("Epoch") { color: #9cdcfe; font-weight: bold; }
    .log-line:contains("Loss:") { color: #ce9178; }
    .log-line:contains("Acc:") { color: #4ec9b0; }
</style>

<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-brain"></i> Continuous Learning System
        </h1>
    </div>
</div>

<!-- Training Status Monitor - Always Visible -->
<div class="row mb-4" id="training-monitor-section">
    <div class="col-12">
        {% if training_status.is_training or (training_status.logs and training_status.logs|length > 0) %}
        <div class="card border-primary">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <span class="status-indicator status-training"></span>
                    <i class="fas fa-cog fa-spin"></i> Training in Progress: {{ training_status.current_crop or 'Continuous Learning' }}
                </h5>
            </div>
        {% elif training_status.status_message and ('completed' in training_status.status_message.lower() or 'success' in training_status.status_message.lower()) %}
        <div class="card border-success shadow-lg">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="fas fa-check-circle"></i> Training Completed Successfully!
                </h5>
            </div>
        {% else %}
        <div class="card border-info">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                    <i class="fas fa-monitor-heart-rate"></i> Training Monitor - Ready
                </h5>
            </div>
        {% endif %}
            <div class="card-body">
                {% if training_status.status_message and ('completed' in training_status.status_message.lower() or 'success' in training_status.status_message.lower()) %}
                <div class="alert alert-success mb-3">
                    <h6><i class="fas fa-check-circle"></i> <strong>{{ training_status.status_message }}</strong></h6>
                    <hr>
                    <p class="mb-1"><strong>What happened:</strong></p>
                    <ul class="mb-0">
                        <li>Model has been trained and saved to <code>models/tomato/tomato_classifier.pth</code></li>
                        <li>Retraining dataset has been automatically cleared</li>
                        <li>You can now provide new feedback and prepare a new dataset for the next training cycle</li>
                    </ul>
                </div>
                {% elif not training_status.is_training and not (training_status.logs and training_status.logs|length > 0) %}
                <div class="text-muted mb-3">
                    <p class="mb-0"><i class="fas fa-info-circle"></i> Real-time logs, progress updates, and status messages will appear here when training starts.</p>
                </div>
                {% endif %}
                
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span id="training-status-message">{% if training_status.status_message %}{{ training_status.status_message }}{% else %}Ready to start training...{% endif %}</span>
                        <span class="badge bg-info" id="training-progress-text">{{ training_status.progress }}%</span>
                    </div>
                    <div class="progress" style="height: 25px;">
                        <div class="progress-bar {% if training_status.is_training %}progress-bar-striped progress-bar-animated bg-success{% else %}bg-secondary{% endif %}" 
                             role="progressbar" 
                             id="training-progress-bar"
                             style="width: {{ training_status.progress }}%"
                             aria-valuenow="{{ training_status.progress }}" 
                             aria-valuemin="0" 
                             aria-valuemax="100">
                            {{ training_status.progress }}%
                        </div>
                    </div>
                </div>
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0"><i class="fas fa-terminal"></i> Training Logs</h6>
                        <div>
                            <button class="btn btn-sm btn-outline-secondary" onclick="clearTrainingLogs()" title="Clear logs">
                                <i class="fas fa-eraser"></i> Clear
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="downloadTrainingLogs()" title="Download logs">
                                <i class="fas fa-download"></i> Download
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="toggleAutoScroll()" id="autoscroll-btn" title="Toggle auto-scroll">
                                <i class="fas fa-arrow-down"></i> Auto-scroll
                            </button>
                        </div>
                    </div>
                    <div class="log-container terminal-style" id="training-logs" style="max-height: 400px; overflow-y: auto; background: #1e1e1e; color: #d4d4d4; padding: 15px; border-radius: 5px; font-family: 'Courier New', monospace; font-size: 0.85em; line-height: 1.4;">
                        {% if training_status.logs and training_status.logs|length > 0 %}
                            {% for log in training_status.logs %}
                                <div class="log-line">{{ log|e }}</div>
                            {% endfor %}
                        {% else %}
                            <div class="log-line" style="color: #808080;">No logs yet. Training logs will appear here when you start training...</div>
                        {% endif %}
                    </div>
                </div>
                {% if training_status.status_message and ('completed' in training_status.status_message.lower() or 'success' in training_status.status_message.lower()) %}
                <div class="row mt-3">
                    <div class="col-md-6">
                        {% if training_status.logs %}
                        <details open>
                            <summary class="btn btn-outline-secondary btn-sm mb-2">
                                <i class="fas fa-terminal"></i> View Training Logs ({{ training_status.logs|length }} lines)
                            </summary>
                            <div class="log-container terminal-style" style="max-height: 300px; overflow-y: auto; padding: 15px; border-radius: 5px; font-size: 0.85em; line-height: 1.4;">
                                {% for log in training_status.logs %}
                                    <div class="log-line">{{ log|e }}</div>
                                {% endfor %}
                            </div>
                        </details>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        <div id="completed-training-charts">
                            <h6><i class="fas fa-chart-line"></i> Training Charts</h6>
                            <div id="completed-charts-container">
                                <img src="/training_curves" 
                                     alt="Training Curves" 
                                     onerror="this.parentElement.innerHTML='<div class=\'alert alert-info\'><i class=\'fas fa-info-circle\'></i> Charts will be available after next training completes.</div>'"
                                     style="max-width: 100%; height: auto; border: 1px solid #ddd; border-radius: 5px;"
                                     onload="this.style.display='block'">
                                <div class="mt-2">
                                    <a href="/training_curves" download="training_curves.png" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-download"></i> Download Chart
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% else %}
                <div id="training-charts-section" style="display: none;">
                    <h6 class="mb-2"><i class="fas fa-chart-line"></i> Training Charts</h6>
                    <div id="training-charts-container"></div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card learning-card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-sync-alt"></i> Automatically improve your model using uploaded test images
                </h5>
            </div>
            <div class="card-body">
                            <!-- Learning Statistics and Actions -->
                            <div class="row mb-4">
                                <div class="col-md-8">
                                    <h5 class="mb-3"><i class="fas fa-chart-bar"></i> Learning Statistics</h5>
                                    <div class="stats-grid" id="learningStats">
                                        <div class="stat-card">
                                            <div class="stat-number" id="totalFeedback">0</div>
                                            <div>Total Feedback</div>
                                        </div>
                                        <div class="stat-card">
                                            <div class="stat-number" id="incorrectPredictions">0</div>
                                            <div>Incorrect Predictions</div>
                                        </div>
                                        <div class="stat-card">
                                            <div class="stat-number" id="learningImages">0</div>
                                            <div>Learning Images</div>
                                        </div>
                                        <div class="stat-card">
                                            <div class="stat-number" id="retrainingNeeded">No</div>
                                            <div>Retraining Status</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <h5 class="mb-3"><i class="fas fa-cogs"></i> Actions</h5>
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-primary" onclick="loadLearningStats()">
                                            <i class="fas fa-refresh"></i> Refresh Stats
                                        </button>
                                        <button class="btn btn-warning" onclick="triggerRetraining()">
                                            <i class="fas fa-folder-open"></i> Prepare Dataset
                                        </button>
                                        <button class="btn btn-success" onclick="startContinuousTraining()">
                                            <i class="fas fa-play-circle"></i> Start Training
                                        </button>
                                        <button class="btn btn-danger" onclick="clearRetrainingDataset()">
                                            <i class="fas fa-trash-alt"></i> Clear Dataset
                                        </button>
                                        <button class="btn btn-info" onclick="showDatasetPrepModal()">
                                            <i class="fas fa-crop"></i> Prepare Multi-Tomato Dataset
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Feedback Section -->
                            <div class="feedback-section mt-4" id="feedbackSection">
                                <h5 class="mb-3"><i class="fas fa-comment-dots"></i> Provide Feedback</h5>
                                <p class="text-muted mb-3">
                                    <i class="fas fa-hand-pointer text-primary"></i> 
                                    Click on any recent image below to automatically fill the form, then select the correct class and submit.
                                </p>
                                
                                <form id="feedbackForm" class="mb-4">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="imagePath" class="form-label">Image Path</label>
                                                <input type="text" class="form-control" id="imagePath" 
                                                       placeholder="Path to the test image" required>
                                            </div>
                                            <div class="mb-3">
                                                <label for="predictedClass" class="form-label">Predicted Class</label>
                                                <select class="form-select" id="predictedClass" required>
                                                    <option value="">Select predicted class</option>
                                                    <option value="not_ready">Not Ready (Unripe)</option>
                                                    <option value="ready">Ready (Ripe)</option>
                                                    <option value="spoilt">Spoilt (Old/Damaged)</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="correctClass" class="form-label">Correct Class</label>
                                                <select class="form-select" id="correctClass" required>
                                                    <option value="">Select correct class</option>
                                                    <option value="not_ready">Not Ready (Unripe)</option>
                                                    <option value="ready">Ready (Ripe)</option>
                                                    <option value="spoilt">Spoilt (Old/Damaged)</option>
                                                </select>
                                            </div>
                                            <div class="mb-3">
                                                <label for="confidence" class="form-label">Prediction Confidence</label>
                                                <input type="number" class="form-control" id="confidence" 
                                                       min="0" max="1" step="0.01" placeholder="0.85" required>
                                            </div>
                                        </div>
                                    </div>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save"></i> Submit Feedback
                                    </button>
                                </form>
                            </div>

                            <!-- Recent Test Images -->
                            <div class="card mt-4">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0"><i class="fas fa-images"></i> Recent Test Images</h5>
                                    <div class="btn-group" role="group">
                                        <button class="btn btn-sm btn-outline-primary" onclick="loadRecentImages()">
                                            <i class="fas fa-refresh"></i> Refresh
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="confirmDeleteAllImages()" title="Delete all recent images">
                                            <i class="fas fa-trash-alt"></i> Clear All
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div id="recentImages">
                                        <p class="text-muted">Loading recent images...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
        // Global variable for training status polling interval
        let trainingStatusInterval = null;
        
        // Load learning statistics
        function loadLearningStats() {
            fetch('/learning_stats')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.stats) {
                        document.getElementById('totalFeedback').textContent = data.stats.total_feedback || 0;
                        document.getElementById('incorrectPredictions').textContent = data.stats.incorrect_predictions || 0;
                        document.getElementById('learningImages').textContent = data.stats.learning_images || 0;
                        const retrainingStatus = data.stats.retraining_needed || 'No';
                        document.getElementById('retrainingNeeded').textContent = retrainingStatus;
                        document.getElementById('retrainingNeeded').className = retrainingStatus === 'Yes' ? 'stat-number text-warning' : 'stat-number';
                    } else {
                        console.error('Failed to load stats:', data.error || 'Unknown error');
                    }
                })
                .catch(error => {
                    console.error('Error loading stats:', error);
                });
        }

        // Submit feedback
        document.getElementById('feedbackForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const feedbackData = {
                image_path: document.getElementById('imagePath').value,
                predicted_class: document.getElementById('predictedClass').value,
                correct_class: document.getElementById('correctClass').value,
                confidence: parseFloat(document.getElementById('confidence').value)
            };
            
            fetch('/feedback', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(feedbackData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Feedback submitted successfully!');
                    document.getElementById('feedbackForm').reset();
                    loadLearningStats();
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error submitting feedback');
            });
        });

        // Trigger retraining (prepare dataset)
        function triggerRetraining() {
            if (confirm('Are you sure you want to prepare the dataset for training? This will organize feedback data into a training dataset.')) {
                const btn = event.target;
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Preparing...';
                
                fetch('/retrain_model', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-folder-open"></i> Prepare Dataset';
                    
                    if (data.success) {
                        alert(`Dataset prepared successfully!\n\nImages copied: ${data.images_copied || 0}\nDataset path: ${data.dataset_path || 'N/A'}\n\nYou can now click "Start Training" to begin training.`);
                        loadLearningStats();
                    } else {
                        alert('Error: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(error => {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-folder-open"></i> Prepare Dataset';
                    console.error('Error:', error);
                    alert('Error preparing dataset: ' + error.message);
                });
            }
        }

        // Start continuous training
        function startContinuousTraining() {
            if (confirm('Are you sure you want to start training? This will use the prepared retraining dataset to train a new model.\n\nTraining may take a while. You can monitor progress and logs in real-time on this page.\n\nThe retraining dataset will be automatically cleared after successful training.')) {
                const btn = event.target;
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Starting...';
                
                fetch('/start_continuous_training', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        epochs: 30,
                        batch_size: 32,
                        learning_rate: 0.001
                    })
                })
                .then(response => response.json())
                .then(data => {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-play-circle"></i> Start Training';
                    
                    if (data.success) {
                        // Show the training monitor section
                        showTrainingMonitor();
                        // Start polling for training status
                        startTrainingStatusPolling();
                        // Scroll to training monitor
                        setTimeout(() => {
                            const monitorSection = document.getElementById('training-monitor-section');
                            if (monitorSection) {
                                monitorSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                            }
                        }, 500);
                    } else {
                        alert('Error: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(error => {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-play-circle"></i> Start Training';
                    console.error('Error:', error);
                    alert('Error starting training: ' + error.message);
                });
            }
        }
        
        // Show training monitor section (now always visible, but update UI state)
        function showTrainingMonitor() {
            // Monitor section is now always visible, just ensure it's in the right state
            const monitorSection = document.getElementById('training-monitor-section');
            if (monitorSection) {
                monitorSection.style.display = 'block';
                // Update header to show training in progress
                const cardHeader = monitorSection.querySelector('.card-header');
                const card = monitorSection.querySelector('.card');
                if (cardHeader && card) {
                    // Change to training state
                    card.classList.remove('border-info', 'border-success');
                    card.classList.add('border-primary');
                    cardHeader.classList.remove('bg-info', 'bg-success');
                    cardHeader.classList.add('bg-primary');
                    cardHeader.innerHTML = `
                        <h5 class="mb-0">
                            <span class="status-indicator status-training"></span>
                            <i class="fas fa-cog fa-spin"></i> Training in Progress: Continuous Learning
                        </h5>
                    `;
                }
            }
        }
        
        // Start polling for training status
        function startTrainingStatusPolling() {
            // Clear any existing interval
            if (trainingStatusInterval) {
                clearInterval(trainingStatusInterval);
            }
            
            let trainingWasActive = false;
            trainingStatusInterval = setInterval(function() {
                fetch('/training_status')
                    .then(response => response.json())
                    .then(data => {
                        if (data.is_training) {
                            trainingWasActive = true;
                            // Ensure monitor is visible and in training state
                            showTrainingMonitor();
                            
                            // Update card header to show training state
                            const monitorSection = document.getElementById('training-monitor-section');
                            if (monitorSection) {
                                const card = monitorSection.querySelector('.card');
                                const cardHeader = monitorSection.querySelector('.card-header');
                                if (card && cardHeader) {
                                    card.classList.remove('border-info', 'border-success');
                                    card.classList.add('border-primary');
                                    cardHeader.classList.remove('bg-info', 'bg-success');
                                    cardHeader.classList.add('bg-primary');
                                    const cropName = data.current_crop || 'Continuous Learning';
                                    cardHeader.innerHTML = `
                                        <h5 class="mb-0">
                                            <span class="status-indicator status-training"></span>
                                            <i class="fas fa-cog fa-spin"></i> Training in Progress: ${cropName}
                                        </h5>
                                    `;
                                }
                            }
                            
                            // Update progress bar
                            const progressBar = document.getElementById('training-progress-bar');
                            const progressText = document.getElementById('training-progress-text');
                            if (progressBar) {
                                progressBar.style.width = data.progress + '%';
                                progressBar.setAttribute('aria-valuenow', data.progress);
                                progressBar.textContent = data.progress + '%';
                                // Ensure progress bar shows as active during training
                                progressBar.classList.remove('bg-secondary');
                                progressBar.classList.add('progress-bar-striped', 'progress-bar-animated', 'bg-success');
                            }
                            if (progressText) {
                                progressText.textContent = data.progress + '%';
                            }
                            
                            // Update status message
                            const statusElement = document.getElementById('training-status-message');
                            if (statusElement) {
                                statusElement.textContent = data.status_message || 'Training in progress...';
                            }
                            
                            // Update logs with syntax highlighting
                            const logContainer = document.getElementById('training-logs');
                            if (logContainer) {
                                const autoScroll = window.trainingAutoScroll !== false;
                                if (data.logs && data.logs.length > 0) {
                                    logContainer.innerHTML = data.logs.map(log => {
                                        const escapedLog = escapeHtml(log);
                                        let coloredLog = escapedLog;
                                        // Add color coding with better regex patterns
                                        coloredLog = coloredLog.replace(/(‚úÖ|Success|successfully|saved to)/gi, '<span style="color: #4ec9b0; font-weight: bold;">$&</span>');
                                        coloredLog = coloredLog.replace(/(‚ùå|Error|Failed|error|Exception)/gi, '<span style="color: #f48771; font-weight: bold;">$&</span>');
                                        coloredLog = coloredLog.replace(/(‚ö†Ô∏è|Warning|warning)/gi, '<span style="color: #dcdcaa;">$&</span>');
                                        coloredLog = coloredLog.replace(/(üìä|Chart|curves|Training curves)/gi, '<span style="color: #569cd6;">$&</span>');
                                        coloredLog = coloredLog.replace(/(Epoch \d+\/\d+)/gi, '<span style="color: #9cdcfe; font-weight: bold;">$&</span>');
                                        coloredLog = coloredLog.replace(/(Train Loss: [\d.]+|Val Loss: [\d.]+)/gi, '<span style="color: #ce9178;">$&</span>');
                                        coloredLog = coloredLog.replace(/(Train Acc: [\d.]+%|Val Acc: [\d.]+%)/gi, '<span style="color: #4ec9b0;">$&</span>');
                                        coloredLog = coloredLog.replace(/(Using device:|Preparing dataset|Starting training)/gi, '<span style="color: #569cd6;">$&</span>');
                                        coloredLog = coloredLog.replace(/(Prepared \d+ train|\d+ val images)/gi, '<span style="color: #4ec9b0;">$&</span>');
                                        return `<div class="log-line">${coloredLog}</div>`;
                                    }).join('');
                                    if (autoScroll) {
                                        logContainer.scrollTop = logContainer.scrollHeight;
                                    }
                                }
                            }
                            
                            // Check if training completed and show charts
                            if (data.status_message && (data.status_message.toLowerCase().includes('completed') || data.status_message.toLowerCase().includes('success'))) {
                                loadTrainingCharts();
                            }
                            
                            // Check if training just completed
                            if (data.status_message && (data.status_message.toLowerCase().includes('completed') || data.status_message.toLowerCase().includes('success'))) {
                                if (trainingWasActive) {
                                    trainingWasActive = false;
                                    // Show completion notification
                                    showTrainingCompletionNotification(data.status_message, data.logs);
                                }
                            }
                        } else {
                            // Training completed, update UI and stop polling
                            if (trainingWasActive) {
                                trainingWasActive = false;
                                clearInterval(trainingStatusInterval);
                                trainingStatusInterval = null;
                                
                                // Update card to show completion state
                                const monitorSection = document.getElementById('training-monitor-section');
                                if (monitorSection) {
                                    const card = monitorSection.querySelector('.card');
                                    const cardHeader = monitorSection.querySelector('.card-header');
                                    if (card && cardHeader && data.status_message && ('completed' in data.status_message.toLowerCase() || 'success' in data.status_message.toLowerCase())) {
                                        card.classList.remove('border-primary', 'border-info');
                                        card.classList.add('border-success');
                                        cardHeader.classList.remove('bg-primary', 'bg-info');
                                        cardHeader.classList.add('bg-success');
                                        cardHeader.innerHTML = `
                                            <h5 class="mb-0">
                                                <i class="fas fa-check-circle"></i> Training Completed Successfully!
                                            </h5>
                                        `;
                                    }
                                }
                                
                                showTrainingCompletionNotification(data.status_message || 'Training completed', data.logs || []);
                                // Optionally reload page after a delay to show completion status
                                // setTimeout(() => {
                                //     location.reload();
                                // }, 3000);
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching training status:', error);
                    });
            }, 2000); // Poll every 2 seconds
        }

        // Clear retraining dataset
        function clearRetrainingDataset() {
            if (confirm('Are you sure you want to clear the retraining dataset?\n\nThis will remove all images from learning_data/retraining_dataset/ but keep the folder structure.\n\nThis is useful if you want to start fresh with new feedback data.')) {
                const btn = event.target;
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Clearing...';
                
                fetch('/clear_retraining_dataset', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-trash-alt"></i> Clear Retraining Dataset';
                    
                    if (data.success) {
                        alert(`Retraining dataset cleared successfully!\n\nRemoved ${data.images_removed || 0} images.\n\nThe dataset is now ready for new feedback data.`);
                        loadLearningStats();
                    } else {
                        alert('Error: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(error => {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-trash-alt"></i> Clear Retraining Dataset';
                    console.error('Error:', error);
                    alert('Error clearing dataset: ' + error.message);
                });
            }
        }

        // Populate feedback form from image data
        function populateFeedbackForm(imagePath, predictedClass, confidence) {
            // Fill in the form fields
            document.getElementById('imagePath').value = imagePath;
            
            if (predictedClass) {
                // Map class names to form values
                const classMap = {
                    'not_ready': 'not_ready',
                    'not ready': 'not_ready',
                    'unripe': 'not_ready',
                    'ready': 'ready',
                    'ripe': 'ready',
                    'spoilt': 'spoilt',
                    'spoiled': 'spoilt',
                    'old': 'spoilt',
                    'damaged': 'spoilt'
                };
                
                const mappedClass = classMap[predictedClass.toLowerCase()] || predictedClass.toLowerCase();
                document.getElementById('predictedClass').value = mappedClass;
            }
            
            if (confidence !== undefined && confidence !== null && confidence > 0) {
                document.getElementById('confidence').value = confidence.toFixed(2);
            }
            
            // Clear correct class (user needs to select this)
            document.getElementById('correctClass').value = '';
            
            // Scroll to feedback form
            const feedbackSection = document.getElementById('feedbackSection');
            feedbackSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            
            // Highlight the form briefly
            const form = document.getElementById('feedbackForm');
            form.style.transition = 'box-shadow 0.3s ease, border 0.3s ease';
            form.style.boxShadow = '0 0 20px rgba(40, 167, 69, 0.6)';
            form.style.border = '2px solid #28a745';
            setTimeout(() => {
                form.style.boxShadow = '';
                form.style.border = '';
            }, 2000);
            
            // Show a brief notification
            const notification = document.createElement('div');
            notification.className = 'alert alert-success alert-dismissible fade show position-fixed';
            notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            notification.innerHTML = `
                <i class="fas fa-check-circle"></i> <strong>Form filled!</strong> Image path and prediction added. Please select the correct class and submit.
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.remove();
            }, 4000);
        }

        // Load recent images
        function loadRecentImages() {
            const container = document.getElementById('recentImages');
            container.innerHTML = '<p class="text-muted">Loading...</p>';
            
            fetch('/recent_learning_images')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.images && data.images.length > 0) {
                        let html = '<div class="row">';
                        data.images.forEach(img => {
                            // Extract relative path from learning_data directory
                            let relativePath = img.path.replace(/\\/g, '/');
                            if (relativePath.startsWith('learning_data/')) {
                                relativePath = relativePath.substring('learning_data/'.length);
                            }
                            const imgUrl = `/learning_image/${relativePath}`;
                            
                            // Get prediction info if available
                            const predictedClass = img.predicted_class || '';
                            const confidence = (img.confidence !== undefined && img.confidence !== null) ? img.confidence : 0;
                            const hasPrediction = predictedClass && confidence > 0;
                            
                            // Escape path for onclick
                            const escapedPath = img.path.replace(/'/g, "\\'");
                            
                            html += `
                                <div class="col-md-3 mb-3" id="image-card-${img.name.replace(/[^a-zA-Z0-9]/g, '_')}">
                                    <div class="card" style="transition: transform 0.2s;" 
                                         onmouseover="this.style.transform='scale(1.05)'" 
                                         onmouseout="this.style.transform='scale(1)'">
                                        <div style="position: relative;">
                                            <img src="${imgUrl}" class="card-img-top" style="height: 150px; object-fit: cover; width: 100%; cursor: pointer;" 
                                                 alt="${img.name}" 
                                                 onclick="populateFeedbackForm('${escapedPath}', '${predictedClass}', ${confidence})"
                                                 onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'200\' height=\'150\'%3E%3Crect fill=\'%23ddd\' width=\'200\' height=\'150\'/%3E%3Ctext fill=\'%23999\' font-family=\'sans-serif\' font-size=\'14\' x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dy=\'.3em\'%3EImage%3C/text%3E%3C/svg%3E'">
                                            <div style="position: absolute; top: 5px; right: 5px; display: flex; gap: 3px;">
                                                <div style="background: rgba(0,0,0,0.6); color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.7rem; cursor: pointer;" 
                                                     onclick="event.stopPropagation(); window.open('${imgUrl}', '_blank')" 
                                                     title="View full image">
                                                    <i class="fas fa-expand"></i>
                                                </div>
                                                <div style="background: rgba(220,53,69,0.8); color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.7rem; cursor: pointer;" 
                                                     onclick="event.stopPropagation(); deleteLearningImage('${escapedPath}', '${img.name.replace(/'/g, "\\'")}')" 
                                                     title="Delete image">
                                                    <i class="fas fa-trash"></i>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="card-body p-2">
                                            <small class="text-muted d-block" style="font-size: 0.75rem;" title="${img.path}">${img.name}</small>
                                            ${hasPrediction ? `
                                                <small class="badge bg-info" style="font-size: 0.65rem;">
                                                    ${predictedClass} (${(confidence * 100).toFixed(0)}%)
                                                </small>
                                            ` : ''}
                                            <small class="text-muted d-block" style="font-size: 0.7rem;">${img.date}</small>
                                            <small class="text-primary d-block mt-1" style="font-size: 0.7rem;">
                                                <i class="fas fa-hand-pointer"></i> Click image to add feedback
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        html += '</div>';
                        container.innerHTML = html;
                    } else {
                        container.innerHTML = '<p class="text-muted">No recent test images found.</p>';
                    }
                })
                .catch(error => {
                    console.error('Error loading images:', error);
                    container.innerHTML = '<p class="text-danger">Error loading images.</p>';
                });
        }

        // Delete a learning image
        function deleteLearningImage(imagePath, imageName) {
            if (!confirm(`Are you sure you want to delete "${imageName}"?\n\nThis will permanently remove the image and its metadata.`)) {
                return;
            }
            
            fetch('/delete_learning_image', {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ image_path: imagePath })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show success notification
                    const notification = document.createElement('div');
                    notification.className = 'alert alert-success alert-dismissible fade show position-fixed';
                    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
                    notification.innerHTML = `
                        <i class="fas fa-check-circle"></i> <strong>Deleted!</strong> Image removed successfully.
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    document.body.appendChild(notification);
                    setTimeout(() => notification.remove(), 3000);
                    
                    // Reload images
                    loadRecentImages();
                    // Update stats
                    loadLearningStats();
                } else {
                    alert('Error: ' + (data.error || 'Failed to delete image'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error deleting image: ' + error.message);
            });
        }

        // Delete all recent images
        function confirmDeleteAllImages() {
            if (!confirm('Are you sure you want to delete ALL recent test images?\n\nThis action cannot be undone and will remove all images and their metadata.')) {
                return;
            }
            
            // Get all images first
            fetch('/recent_learning_images')
                .then(response => response.json())
                .then(data => {
                    if (!data.success || !data.images || data.images.length === 0) {
                        alert('No images to delete.');
                        return;
                    }
                    
                    if (!confirm(`This will delete ${data.images.length} image(s). Continue?`)) {
                        return;
                    }
                    
                    // Delete all images
                    let deleted = 0;
                    let failed = 0;
                    const total = data.images.length;
                    
                    data.images.forEach((img, index) => {
                        fetch('/delete_learning_image', {
                            method: 'DELETE',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ image_path: img.path })
                        })
                        .then(response => response.json())
                        .then(result => {
                            if (result.success) {
                                deleted++;
                            } else {
                                failed++;
                            }
                            
                            // Check if all deletions are complete
                            if (deleted + failed === total) {
                                const message = failed > 0 
                                    ? `Deleted ${deleted} of ${total} images. ${failed} failed.`
                                    : `Successfully deleted all ${deleted} images!`;
                                
                                alert(message);
                                loadRecentImages();
                                loadLearningStats();
                            }
                        })
                        .catch(error => {
                            failed++;
                            if (deleted + failed === total) {
                                alert(`Deleted ${deleted} of ${total} images. ${failed} failed.`);
                                loadRecentImages();
                                loadLearningStats();
                            }
                        });
                    });
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error loading images: ' + error.message);
                });
        }

        // Dataset Preparation Modal
        function showDatasetPrepModal() {
            const modal = new bootstrap.Modal(document.getElementById('datasetPrepModal'));
            modal.show();
        }

        function startDatasetPreparation() {
            const sourceDir = document.getElementById('prepSourceDir').value;
            const outputDir = document.getElementById('prepOutputDir').value;
            const allSplits = document.getElementById('prepAllSplits').checked;
            const split = document.getElementById('prepSplit').value;

            if (!sourceDir || !outputDir) {
                alert('Please provide both source and output directories');
                return;
            }

            const btn = document.getElementById('prepStartBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Preparing...';

            fetch('/prepare_multi_tomato_dataset', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    source_dir: sourceDir,
                    output_dir: outputDir,
                    all_splits: allSplits,
                    split: split
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Start polling for status
                    pollDatasetPrepStatus();
                    document.getElementById('prepStatusDiv').style.display = 'block';
                    document.getElementById('prepStatusDiv').innerHTML = '<div class="alert alert-info"><i class="fas fa-spinner fa-spin"></i> Preparation in progress...</div>';
                } else {
                    alert('Error: ' + (data.error || 'Failed to start preparation'));
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-play"></i> Start Preparation';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error starting preparation: ' + error.message);
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-play"></i> Start Preparation';
            });
        }

        function pollDatasetPrepStatus() {
            const statusInterval = setInterval(() => {
                fetch('/dataset_prep_status')
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'not_started') {
                            return; // Still running
                        }

                        clearInterval(statusInterval);
                        const statusDiv = document.getElementById('prepStatusDiv');
                        const btn = document.getElementById('prepStartBtn');

                        if (data.success) {
                            // Parse output for statistics
                            let statsHtml = '<div class="alert alert-success"><h6><i class="fas fa-check-circle"></i> Preparation Complete!</h6>';
                            
                            // Try to extract stats from stdout
                            if (data.stdout) {
                                const lines = data.stdout.split('\n');
                                lines.forEach(line => {
                                    if (line.includes('Total source images') || 
                                        line.includes('Single-tomato images') ||
                                        line.includes('Multi-tomato images') ||
                                        line.includes('Total cropped tomatoes') ||
                                        line.includes('Final dataset size') ||
                                        line.includes('By class')) {
                                        statsHtml += '<p class="mb-1"><small>' + line.trim() + '</small></p>';
                                    }
                                });
                            }
                            
                            statsHtml += '</div>';
                            statusDiv.innerHTML = statsHtml;
                        } else {
                            statusDiv.innerHTML = '<div class="alert alert-danger"><h6><i class="fas fa-exclamation-circle"></i> Preparation Failed</h6><p>' + (data.error || data.stderr || 'Unknown error') + '</p></div>';
                        }

                        btn.disabled = false;
                        btn.innerHTML = '<i class="fas fa-play"></i> Start Preparation';
                    })
                    .catch(error => {
                        console.error('Error checking status:', error);
                    });
            }, 2000); // Poll every 2 seconds
        }

        // Load available datasets
        function loadAvailableDatasets() {
            fetch('/api/datasets/list')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.datasets) {
                        const select = document.getElementById('prepSourceDirSelect');
                        data.datasets.forEach(dataset => {
                            const option = document.createElement('option');
                            option.value = dataset.path;
                            option.textContent = dataset.display;
                            select.appendChild(option);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error loading datasets:', error);
                });
        }

        function updateSourceDir() {
            const select = document.getElementById('prepSourceDirSelect');
            const input = document.getElementById('prepSourceDir');
            if (select.value) {
                input.value = select.value;
            }
        }

        // Auto-refresh training status on page load if training is already active
        {% if training_status.is_training %}
        // Start polling if training is already active
        if (!trainingStatusInterval) {
            startTrainingStatusPolling();
        }
        {% endif %}

        // Show training completion notification
        function showTrainingCompletionNotification(message, logs) {
            // Create a prominent notification
            const notification = document.createElement('div');
            notification.className = 'alert alert-success alert-dismissible fade show position-fixed';
            notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 400px; max-width: 600px; box-shadow: 0 4px 6px rgba(0,0,0,0.3);';
            notification.innerHTML = `
                <h5><i class="fas fa-check-circle"></i> Training Completed!</h5>
                <p><strong>${message}</strong></p>
                <p class="mb-0"><small>Model saved to models/tomato/. The retraining dataset has been cleared.</small></p>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(notification);
            
            // Also show browser notification if supported
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('Training Completed!', {
                    body: message,
                    icon: '/static/favicon.ico'
                });
            } else if ('Notification' in window && Notification.permission !== 'denied') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        new Notification('Training Completed!', {
                            body: message,
                            icon: '/static/favicon.ico'
                        });
                    }
                });
            }
            
            // Auto-remove after 10 seconds
            setTimeout(() => {
                notification.remove();
            }, 10000);
        }

        // Training log management
        window.trainingAutoScroll = true;
        
        function clearTrainingLogs() {
            const logContainer = document.getElementById('training-logs');
            if (logContainer && confirm('Clear all training logs?')) {
                logContainer.innerHTML = '<div class="log-line" style="color: #808080;">Logs cleared...</div>';
            }
        }
        
        function downloadTrainingLogs() {
            fetch('/training_status')
                .then(response => response.json())
                .then(data => {
                    const logs = data.logs || [];
                    const logText = logs.join('\n');
                    const blob = new Blob([logText], { type: 'text/plain' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `training_logs_${new Date().toISOString().replace(/[:.]/g, '-')}.txt`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                });
        }
        
        function toggleAutoScroll() {
            window.trainingAutoScroll = !window.trainingAutoScroll;
            const btn = document.getElementById('autoscroll-btn');
            if (btn) {
                if (window.trainingAutoScroll) {
                    btn.innerHTML = '<i class="fas fa-arrow-down"></i> Auto-scroll';
                    btn.classList.remove('btn-danger');
                    btn.classList.add('btn-outline-secondary');
                } else {
                    btn.innerHTML = '<i class="fas fa-pause"></i> Paused';
                    btn.classList.remove('btn-outline-secondary');
                    btn.classList.add('btn-danger');
                }
            }
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function loadTrainingCharts() {
            // Check if training curves exist
            const chartsSection = document.getElementById('training-charts-section');
            const chartsContainer = document.getElementById('training-charts-container');
            
            if (chartsSection && chartsContainer) {
                // Try to load charts from multiple possible locations
                const chartPaths = [
                    '/static/training_curves.png',
                    '/training_curves',
                    '/models/tomato/training_curves.png'
                ];
                
                // Check if chart exists by trying to load it
                const img = document.createElement('img');
                img.style.maxWidth = '100%';
                img.style.height = 'auto';
                img.style.border = '1px solid #ddd';
                img.style.borderRadius = '5px';
                img.style.marginTop = '10px';
                
                let loaded = false;
                chartPaths.forEach((path, index) => {
                    if (!loaded) {
                        const testImg = new Image();
                        testImg.onload = function() {
                            if (!loaded) {
                                img.src = path;
                                chartsContainer.innerHTML = `
                                    <div class="alert alert-info">
                                        <i class="fas fa-chart-line"></i> Training curves generated during training
                                    </div>
                                    <img src="${path}?t=${Date.now()}" alt="Training Curves" style="max-width: 100%; height: auto; border: 1px solid #ddd; border-radius: 5px; margin-top: 10px;">
                                    <div class="mt-2">
                                        <a href="${path}?t=${Date.now()}" download="training_curves.png" class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-download"></i> Download Chart
                                        </a>
                                    </div>
                                `;
                                chartsSection.style.display = 'block';
                                loaded = true;
                            }
                        };
                        testImg.onerror = function() {
                            if (index === chartPaths.length - 1 && !loaded) {
                                chartsContainer.innerHTML = '<div class="alert alert-warning">Training charts will be available after training completes.</div>';
                                chartsSection.style.display = 'block';
                            }
                        };
                        testImg.src = path + '?t=' + Date.now();
                    }
                });
            }
        }

        // Load stats on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadLearningStats();
            loadRecentImages();
            loadAvailableDatasets();
            // Load charts if training is completed
            {% if training_status.status_message and ('completed' in training_status.status_message.lower() or 'success' in training_status.status_message.lower()) %}
            loadTrainingCharts();
            {% endif %}
        });
</script>

<!-- Dataset Preparation Modal -->
<div class="modal fade" id="datasetPrepModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-crop"></i> Prepare Multi-Tomato Dataset
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <strong>What this does:</strong> Automatically detects and crops individual tomatoes from images with multiple tomatoes, 
                    preparing them for training. Single-tomato images are kept as-is.
                </div>
                
                <form id="datasetPrepForm">
                    <div class="mb-3">
                        <label for="prepSourceDir" class="form-label">Source Dataset Directory</label>
                        <div class="input-group">
                            <select class="form-select" id="prepSourceDirSelect" onchange="updateSourceDir()">
                                <option value="">Select a dataset...</option>
                            </select>
                            <input type="text" class="form-control" id="prepSourceDir" 
                                   placeholder="Or enter path manually" required>
                        </div>
                        <small class="form-text text-muted">Path to your existing dataset with class folders (train/val/test)</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="prepOutputDir" class="form-label">Output Dataset Directory</label>
                        <input type="text" class="form-control" id="prepOutputDir" 
                               placeholder="e.g., /path/to/datasets/tomato_dataset_prepared" required>
                        <small class="form-text text-muted">Where to save the prepared dataset with cropped tomatoes</small>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="prepAllSplits" checked>
                            <label class="form-check-label" for="prepAllSplits">
                                Process all splits (train, val, test)
                            </label>
                        </div>
                    </div>
                    
                    <div class="mb-3" id="prepSplitDiv" style="display: none;">
                        <label for="prepSplit" class="form-label">Split</label>
                        <select class="form-select" id="prepSplit">
                            <option value="train">Train</option>
                            <option value="val">Validation</option>
                            <option value="test">Test</option>
                        </select>
                    </div>
                </form>
                
                <div id="prepStatusDiv" style="display: none;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="prepStartBtn" onclick="startDatasetPreparation()">
                    <i class="fas fa-play"></i> Start Preparation
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    // Toggle split selection based on checkbox
    document.getElementById('prepAllSplits').addEventListener('change', function() {
        document.getElementById('prepSplitDiv').style.display = this.checked ? 'none' : 'block';
    });
</script>
{% endblock %}
