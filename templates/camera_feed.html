{% extends "base.html" %}

{% block title %}Live Camera Feed{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">
                        <i class="fas fa-video"></i> Live Camera Feed
                    </h4>
                    <div class="d-flex gap-2 align-items-center">
                        <select id="camera-selector-header" class="form-select form-select-sm" onchange="switchCamera()" style="width: auto; min-width: 150px;">
                            <option value="">Loading cameras...</option>
                        </select>
                        <button class="btn btn-sm btn-outline-light" onclick="refreshCameraList()" title="Refresh Camera List">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="camera-container" style="position: relative; background-color: #000; min-height: 300px; border: 2px solid #007bff; border-radius: 8px; overflow: hidden;">
                                <img src="" 
                                     class="img-fluid" 
                                     id="camera-feed"
                                     style="max-width: 100%; height: auto; display: block;">
                                <div id="camera-placeholder" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; text-align: center; pointer-events: none; z-index: 10;">
                                    <i class="fas fa-camera fa-3x mb-3"></i>
                                    <p>Camera stopped. Click "Start Camera" to begin.</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <!-- Camera Controls -->
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-cog"></i> Camera Controls</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <div class="d-grid gap-2">
                                            <button class="btn btn-primary" onclick="startCamera()">
                                                <i class="fas fa-play"></i> Start Camera
                                            </button>
                                            <button class="btn btn-secondary" onclick="stopCamera()">
                                                <i class="fas fa-stop"></i> Stop Camera
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label"><i class="fas fa-video"></i> Select Camera</label>
                                        <select id="camera-selector" class="form-select form-select-sm mb-2" onchange="switchCamera()">
                                            <option value="">Loading cameras...</option>
                                        </select>
                                        <button class="btn btn-sm btn-outline-secondary w-100" onclick="refreshCameraList()">
                                            <i class="fas fa-sync-alt"></i> Refresh List
                                        </button>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <div id="camera-status" class="alert alert-info mb-0">
                                            <small><strong>Status:</strong> Ready</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Actions -->
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-tasks"></i> Actions</h6>
                                </div>
                                <div class="card-body">
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-success" onclick="captureImage()">
                                            <i class="fas fa-camera"></i> Capture Image
                                        </button>
                                        <button class="btn btn-info" onclick="classifyImage()">
                                            <i class="fas fa-brain"></i> Classify Current Frame
                                        </button>
                                    </div>
                                    
                                    <div id="classification-results" class="mt-3" style="display: none;">
                                        <h6 class="small">Latest Classification:</h6>
                                        <div id="prediction-details"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Tomato Detection Status -->
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-search"></i> Detection Status</h6>
                                </div>
                                <div class="card-body">
                                    <div id="tomato-detection" class="alert alert-info mb-0">
                                        <small><strong>Status:</strong> Monitoring active when camera is running</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let cameraInterval;
let isCameraRunning = false;
let tomatoMonitoringInterval;
let isTomatoMonitoring = false;

// Camera management functions
async function loadCameraList(forceRefresh = false) {
    try {
        const url = forceRefresh ? '/api/camera/list?refresh=true' : '/api/camera/list';
        const response = await fetch(url);
        const result = await response.json();
        
        if (result.success && result.cameras) {
            // Update both selectors (header and controls panel)
            const selectors = [
                document.getElementById('camera-selector'),
                document.getElementById('camera-selector-header')
            ].filter(s => s !== null);
            
            if (selectors.length === 0) return;
            
            selectors.forEach(selector => {
                selector.innerHTML = '';
                
                if (result.cameras.length === 0) {
                    selector.innerHTML = '<option value="">No cameras found</option>';
                    return;
                }
                
                result.cameras.forEach(camera => {
                    const option = document.createElement('option');
                    option.value = camera.index;
                    const typeLabel = camera.type ? ` [${camera.type}]` : '';
                    option.textContent = `${camera.name}${typeLabel} (${camera.resolution})${camera.current ? ' [Current]' : ''}`;
                    if (camera.current) {
                        option.selected = true;
                    }
                    selector.appendChild(option);
                });
            });
        }
    } catch (error) {
        console.error('Error loading camera list:', error);
        const selectors = [
            document.getElementById('camera-selector'),
            document.getElementById('camera-selector-header')
        ].filter(s => s !== null);
        
        selectors.forEach(selector => {
            selector.innerHTML = '<option value="">Error loading cameras</option>';
        });
    }
}

async function switchCamera() {
    // Get camera index from either selector
    const selector = document.getElementById('camera-selector') || document.getElementById('camera-selector-header');
    if (!selector) return;
    
    const cameraIndex = parseInt(selector.value);
    if (isNaN(cameraIndex)) return;
    
    try {
        const response = await fetch('/api/camera/switch', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({index: cameraIndex})
        });
        
        const result = await response.json();
        if (result.success) {
            updateStatus(`Switched to camera ${cameraIndex}`, 'success');
            // Refresh camera list to update current indicator in both selectors
            setTimeout(loadCameraList, 500);
            // Restart camera feed if it's running
            if (isCameraRunning) {
                stopCamera();
                setTimeout(startCamera, 500);
            }
        } else {
            updateStatus('Failed to switch camera: ' + result.message, 'danger');
        }
    } catch (error) {
        updateStatus('Error switching camera: ' + error.message, 'danger');
    }
}

function refreshCameraList() {
    loadCameraList(true); // Force refresh to re-detect all cameras
}

async function startCamera() {
    if (!isCameraRunning) {
        // Auto-start tomato monitoring when camera starts
        if (!isTomatoMonitoring) {
            startTomatoMonitoring();
        }
        // Make sure we're using the selected camera
        const selector = document.getElementById('camera-selector') || document.getElementById('camera-selector-header');
        if (selector && selector.value) {
            const cameraIndex = parseInt(selector.value);
            if (!isNaN(cameraIndex)) {
                // Switch to selected camera before starting
                try {
                    const response = await fetch('/api/camera/switch', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({index: cameraIndex})
                    });
                    
                    if (!response.ok) {
                        console.error(`Camera switch failed with status ${response.status}`);
                        const errorText = await response.text();
                        console.error('Error response:', errorText);
                        updateStatus('Warning: Could not switch to selected camera. Using default.', 'warning');
                    } else {
                        const result = await response.json();
                        if (!result.success) {
                            updateStatus('Warning: Could not switch to selected camera. Using default.', 'warning');
                        } else {
                            console.log(`Successfully switched to camera ${cameraIndex}`);
                        }
                    }
                } catch (error) {
                    console.error('Error switching camera before start:', error);
                    updateStatus('Warning: Could not switch to selected camera. Using default.', 'warning');
                }
            }
        }
        
        const cameraFeed = document.getElementById('camera-feed');
        const placeholder = document.getElementById('camera-placeholder');
        
        // Hide placeholder
        if (placeholder) {
            placeholder.style.display = 'none';
        }
        
        // Use /api/camera/feed which uses hardware controller and respects camera selection
        // Add timestamp to prevent caching
        cameraFeed.src = "/api/camera/feed?" + new Date().getTime();
        isCameraRunning = true;
        
        updateStatus('Camera started - Detection active', 'success');
    }
}

function stopCamera() {
    // Always allow stopping, even if state is inconsistent
    const cameraFeed = document.getElementById('camera-feed');
    const placeholder = document.getElementById('camera-placeholder');
    
    // Stop the camera feed by removing the src attribute
    // This stops the browser from making requests to the video feed
    if (cameraFeed) {
        cameraFeed.removeAttribute('src');
        cameraFeed.src = ''; // Clear src completely
        
        // Force the image to stop loading
        try {
            cameraFeed.load(); // This forces the browser to stop loading
        } catch (e) {
            // Ignore errors
        }
    }
    
    // Show placeholder
    if (placeholder) {
        placeholder.style.display = 'block';
    }
    
    // Stop auto-capture if running
    if (cameraInterval) {
        clearInterval(cameraInterval);
        cameraInterval = null;
    }
    
    // Stop tomato monitoring if running
    if (isTomatoMonitoring) {
        stopTomatoMonitoring();
    }
    
    isCameraRunning = false;
    updateStatus('Camera stopped', 'warning');
}

// Stop camera feed when page is unloaded
window.addEventListener('beforeunload', function() {
    stopCamera();
});

window.addEventListener('pagehide', function() {
    stopCamera();
});

function captureImage() {
    // Create a canvas to capture the current frame
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    const img = document.getElementById('camera-feed');
    
    canvas.width = img.naturalWidth || img.width;
    canvas.height = img.naturalHeight || img.height;
    
    ctx.drawImage(img, 0, 0);
    
    // Convert to blob and send to server
    canvas.toBlob(function(blob) {
        const formData = new FormData();
        formData.append('image', blob, 'captured_image.jpg');
        
        fetch('/capture_image', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateStatus('Image captured successfully', 'success');
            } else {
                updateStatus('Capture failed: ' + data.error, 'danger');
            }
        })
        .catch(error => {
            updateStatus('Capture error: ' + error, 'danger');
        });
    }, 'image/jpeg');
}

function classifyImage() {
    updateStatus('Classifying image...', 'info');
    
    // Capture and classify
    captureAndClassify();
}

function captureAndClassify() {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    const img = document.getElementById('camera-feed');
    
    canvas.width = img.naturalWidth || img.width;
    canvas.height = img.naturalHeight || img.height;
    
    ctx.drawImage(img, 0, 0);
    
    canvas.toBlob(function(blob) {
        const formData = new FormData();
        formData.append('image', blob, 'live_classification.jpg');
        
        fetch('/test_model/tomato', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            // Validate data structure
            if (!data || typeof data !== 'object') {
                console.error('Invalid response data:', data);
                throw new Error('Invalid response from server');
            }
            
            if (data.success) {
                // Handle the response format - it can have 'results' array or direct 'prediction'
                if (data.results && Array.isArray(data.results) && data.results.length > 0) {
                    // Multiple tomatoes detected - show the first one or aggregate
                    const firstResult = data.results[0];
                    if (!firstResult || typeof firstResult !== 'object') {
                        console.error('Invalid firstResult:', firstResult);
                        throw new Error('Invalid result data');
                    }
                    
                    // Ensure prediction exists and is a string
                    let prediction = 'Unknown';
                    if (firstResult.prediction !== undefined && firstResult.prediction !== null) {
                        prediction = String(firstResult.prediction);
                    }
                    
                    const confidence = (firstResult.confidence !== undefined && firstResult.confidence !== null) 
                        ? parseFloat(firstResult.confidence) 
                        : 0.0;
                    
                    displayClassification({
                        prediction: prediction,
                        confidence: confidence,
                        tomato_count: data.tomato_count || data.results.length,
                        multi_tomato: data.multi_tomato || false
                    });
                    if (data.tomato_count > 1) {
                        updateStatus(`Classification complete - ${data.tomato_count} tomatoes detected`, 'success');
                    } else {
                        updateStatus('Classification complete', 'success');
                    }
                } else if (data.prediction !== undefined && data.prediction !== null) {
                    // Direct prediction format (backward compatibility)
                    // Ensure prediction is a valid string
                    const prediction = String(data.prediction);
                    const confidence = (data.confidence !== undefined && data.confidence !== null) 
                        ? parseFloat(data.confidence) 
                        : 0.0;
                    
                    displayClassification({
                        prediction: prediction,
                        confidence: confidence,
                        tomato_count: data.tomato_count || 1
                    });
                    updateStatus('Classification complete', 'success');
                } else {
                    updateStatus('No tomatoes detected in image', 'warning');
                }
            } else {
                const errorMsg = (data.error && typeof data.error === 'string') ? data.error : 'Unknown error';
                updateStatus('Classification failed: ' + errorMsg, 'danger');
                // Show error in classification results too
                const resultsDiv = document.getElementById('classification-results');
                const detailsDiv = document.getElementById('prediction-details');
                if (resultsDiv && detailsDiv) {
                    detailsDiv.innerHTML = `
                        <div class="alert alert-danger mb-0">
                            <strong>Error:</strong> ${errorMsg}<br>
                            <small>Make sure tomatoes are clearly visible in the frame and the model is loaded.</small>
                        </div>
                    `;
                    resultsDiv.style.display = 'block';
                }
            }
        })
        .catch(error => {
            console.error('Classification error:', error);
            console.error('Error stack:', error.stack);
            const errorMsg = (error && error.message) ? error.message : String(error);
            updateStatus('Classification error: ' + errorMsg, 'danger');
            // Show error in classification results
            const resultsDiv = document.getElementById('classification-results');
            const detailsDiv = document.getElementById('prediction-details');
            if (resultsDiv && detailsDiv) {
                detailsDiv.innerHTML = `
                    <div class="alert alert-danger mb-0">
                        <strong>Error:</strong> ${errorMsg}<br>
                        <small>Check browser console (F12) and server console for details.</small>
                    </div>
                `;
                resultsDiv.style.display = 'block';
            }
        });
    }, 'image/jpeg');
}

function displayClassification(data) {
    const resultsDiv = document.getElementById('classification-results');
    const detailsDiv = document.getElementById('prediction-details');
    
    if (!resultsDiv || !detailsDiv) {
        console.error('displayClassification: Missing DOM elements');
        return;
    }
    
    // Validate data parameter
    if (!data || typeof data !== 'object') {
        console.error('displayClassification: Invalid data parameter:', data);
        data = { prediction: 'Unknown', confidence: 0.0 };
    }
    
    const classNames = {
        'ready': 'Ready (Ripe)',
        'not_ready': 'Not Ready (Unripe)',
        'spoilt': 'Spoilt (Old/Damaged)'
    };
    
    // Handle prediction value - it might be in different formats
    let prediction = null;
    if (data && typeof data === 'object') {
        prediction = data.prediction;
        if (!prediction && data.results && Array.isArray(data.results) && data.results.length > 0) {
            prediction = data.results[0]?.prediction;
        }
    }
    
    // Ensure prediction is a string and handle undefined/null
    if (!prediction || typeof prediction !== 'string') {
        console.warn('displayClassification: Invalid prediction value:', prediction, 'Type:', typeof prediction);
        prediction = 'Unknown';
    }
    
    // Final safety check before calling toLowerCase
    if (typeof prediction !== 'string') {
        console.error('displayClassification: Prediction is still not a string after validation:', prediction);
        prediction = 'Unknown';
    }
    
    // Safe toLowerCase with try-catch as final safety net
    let predictionLower = 'unknown';
    try {
        predictionLower = String(prediction).toLowerCase();
    } catch (e) {
        console.error('displayClassification: Error calling toLowerCase:', e, 'prediction:', prediction);
        predictionLower = 'unknown';
    }
    const className = classNames[predictionLower] || prediction || 'Unknown';
    const confidence = ((data.confidence || (data.results && data.results[0]?.confidence) || 0) * 100).toFixed(1);
    const tomatoCount = data.tomato_count || 1;
    
    // Ensure prediction is safe for getClassColor and getClassIcon
    const safePrediction = (typeof prediction === 'string') ? prediction : 'Unknown';
    
    let resultHtml = `
        <div class="alert alert-${getClassColor(safePrediction)} mb-0">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <strong>${className}</strong><br>
                    <small>Confidence: ${confidence}%</small>
                    ${tomatoCount > 1 ? `<br><small class="text-muted">${tomatoCount} tomatoes detected</small>` : ''}
                </div>
                <i class="fas fa-${getClassIcon(safePrediction)} fa-2x"></i>
            </div>
        </div>
    `;
    
    detailsDiv.innerHTML = resultHtml;
    resultsDiv.style.display = 'block';
}

function getClassColor(prediction) {
    // Multiple safety checks
    if (prediction === null || prediction === undefined) {
        return 'info';
    }
    if (typeof prediction !== 'string') {
        console.warn('getClassColor: prediction is not a string:', prediction, typeof prediction);
        return 'info';
    }
    
    // Safe toLowerCase with try-catch
    let predictionLower = 'unknown';
    try {
        predictionLower = String(prediction).toLowerCase();
    } catch (e) {
        console.error('getClassColor: Error calling toLowerCase:', e, 'prediction:', prediction);
        return 'info';
    }
    
    switch(predictionLower) {
        case 'ready': return 'success';
        case 'not_ready': return 'warning';
        case 'spoilt': return 'danger';
        default: return 'info';
    }
}

function getClassIcon(prediction) {
    // Multiple safety checks
    if (prediction === null || prediction === undefined) {
        return 'question-circle';
    }
    if (typeof prediction !== 'string') {
        console.warn('getClassIcon: prediction is not a string:', prediction, typeof prediction);
        return 'question-circle';
    }
    
    // Safe toLowerCase with try-catch
    let predictionLower = 'unknown';
    try {
        predictionLower = String(prediction).toLowerCase();
    } catch (e) {
        console.error('getClassIcon: Error calling toLowerCase:', e, 'prediction:', prediction);
        return 'question-circle';
    }
    
    switch(predictionLower) {
        case 'ready': return 'check-circle';
        case 'not_ready': return 'clock';
        case 'spoilt': return 'exclamation-triangle';
        default: return 'question-circle';
    }
}

function updateStatus(message, type) {
    const statusDiv = document.getElementById('camera-status');
    if (!statusDiv) {
        console.log(`Status: ${message} (${type})`);
        return;
    }
    statusDiv.className = `alert alert-${type} mb-0`;
    statusDiv.innerHTML = `<small><strong>Status:</strong> ${message}</small>`;
}

function checkCameraStatus() {
    fetch('/camera_status')
        .then(response => response.json())
        .then(data => {
            if (data.available) {
                updateStatus(`Camera ready (Index ${data.camera_index || 'N/A'})`, 'success');
            } else {
                updateStatus('Camera not available', 'warning');
            }
        })
        .catch(error => {
            updateStatus('Error checking camera', 'danger');
        });
}

function checkTomatoDetection() {
    fetch('/tomato_detection_status')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            const detectionDiv = document.getElementById('tomato-detection');
            if (!detectionDiv) return;
            
            // Parse timestamp safely
            let timeString = 'N/A';
            if (data.timestamp) {
                try {
                    const timestamp = new Date(data.timestamp);
                    if (!isNaN(timestamp.getTime())) {
                        timeString = timestamp.toLocaleTimeString();
                    }
                } catch (e) {
                    timeString = 'Invalid Date';
                }
            }
            
            if (data.detected) {
                detectionDiv.className = 'alert alert-success mb-0';
                detectionDiv.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <strong><i class="fas fa-check-circle"></i> Tomatoes Detected</strong>
                        <span class="badge bg-success">${data.tomato_count || 0}</span>
                    </div>
                    <small class="text-muted">Last update: ${timeString}</small>
                `;
            } else {
                detectionDiv.className = 'alert alert-warning mb-0';
                detectionDiv.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <strong><i class="fas fa-search"></i> No Tomatoes</strong>
                        <span class="badge bg-secondary">0</span>
                    </div>
                    <small class="text-muted">Last update: ${timeString}</small>
                `;
            }
        })
        .catch(error => {
            const detectionDiv = document.getElementById('tomato-detection');
            if (!detectionDiv) return;
            detectionDiv.className = 'alert alert-danger mb-0';
            detectionDiv.innerHTML = `<small><strong>Error:</strong> ${error.message || error}</small>`;
        });
}

function startTomatoMonitoring() {
    if (!isTomatoMonitoring) {
        isTomatoMonitoring = true;
        tomatoMonitoringInterval = setInterval(checkTomatoDetection, 2000); // Check every 2 seconds
        updateTomatoStatus('Tomato monitoring started', 'success');
    }
}

function stopTomatoMonitoring() {
    if (isTomatoMonitoring) {
        isTomatoMonitoring = false;
        if (tomatoMonitoringInterval) {
            clearInterval(tomatoMonitoringInterval);
            tomatoMonitoringInterval = null;
        }
        updateTomatoStatus('Tomato monitoring stopped', 'warning');
    }
}

function updateTomatoStatus(message, type) {
    const statusDiv = document.getElementById('tomato-detection');
    if (!statusDiv) {
        console.log(`Tomato Status: ${message} (${type})`);
        return;
    }
    statusDiv.className = `alert alert-${type}`;
    statusDiv.innerHTML = `<strong>Tomato Status:</strong> ${message}`;
}

// Global error handler for unhandled promise rejections
window.addEventListener('unhandledrejection', function(event) {
    console.error('Unhandled promise rejection:', event.reason);
    // Prevent the error from appearing in console if it's a known issue
    if (event.reason && typeof event.reason === 'object') {
        // Check if it's a 403 error that we can safely ignore
        if (event.reason.code === 403 && event.reason.httpStatus === 200) {
            event.preventDefault(); // Suppress the error
            console.warn('Suppressed 403 error (likely from a library):', event.reason);
        }
    }
});

// Initialize page when loaded
document.addEventListener('DOMContentLoaded', function() {
    // Load camera list on page load
    loadCameraList();
    checkCameraStatus();
    
    // Show placeholder initially
    const placeholder = document.getElementById('camera-placeholder');
    if (placeholder) {
        placeholder.style.display = 'block';
    }
});
</script>

<style>
.camera-container {
    position: relative;
    background: #f8f9fa;
    border-radius: 8px;
    padding: 10px;
    min-height: 400px;
    display: flex;
    align-items: center;
    justify-content: center;
}

#camera-feed {
    max-height: 500px;
    object-fit: contain;
}

.card {
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.btn {
    margin: 2px;
}
</style>
{% endblock %}
