<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FarmBOT - Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .status-card {
            transition: all 0.3s ease;
        }

        .status-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .camera-feed {
            border: 2px solid #dee2e6;
            border-radius: 10px;
            overflow: hidden;
        }

        .control-btn {
            margin: 5px;
            min-width: 120px;
        }

        .log-container {
            height: 300px;
            overflow-y: auto;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-success">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-robot"></i> FarmBOT
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/control">Control</a>
                <a class="nav-link" href="/monitor">Monitor</a>
                <a class="nav-link" href="/calibrate">Calibrate</a>
                <a class="nav-link" href="/training">Training</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <!-- System Status -->
            <div class="col-md-6">
                <div class="card status-card">
                    <div class="card-header bg-primary text-white">
                        <h5><i class="fas fa-info-circle"></i> System Status</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fas fa-video me-2"></i>
                                    <span>Camera:</span>
                                    <span id="camera-status" class="badge bg-secondary ms-2">Unknown</span>
                                </div>
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fas fa-microchip me-2"></i>
                                    <span>Arduino:</span>
                                    <span id="arduino-status" class="badge bg-secondary ms-2">Unknown</span>
                                </div>
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fas fa-bluetooth me-2"></i>
                                    <span>Bluetooth:</span>
                                    <span id="bluetooth-status" class="badge bg-secondary ms-2">Unknown</span>
                                </div>
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fas fa-brain me-2"></i>
                                    <span>AI Model:</span>
                                    <span id="model-status" class="badge bg-secondary ms-2">Unknown</span>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fas fa-play me-2"></i>
                                    <span>System:</span>
                                    <span id="system-status" class="badge bg-secondary ms-2">Stopped</span>
                                </div>
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fas fa-sort me-2"></i>
                                    <span>Detections:</span>
                                    <span id="detection-count" class="badge bg-info ms-2">0</span>
                                </div>
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fas fa-clock me-2"></i>
                                    <span>Last Detection:</span>
                                    <span id="last-detection" class="text-muted ms-2">Never</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Controls -->
            <div class="col-md-6">
                <div class="card status-card">
                    <div class="card-header bg-success text-white">
                        <h5><i class="fas fa-gamepad"></i> Quick Controls</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="autoModeToggle">
                                <label class="form-check-label fw-bold" for="autoModeToggle">AUTOMATIC MODE</label>
                            </div>
                            <button class="btn btn-success" id="btn-start" onclick="startSystem()">
                                <i class="fas fa-play"></i> Start System
                            </button>
                            <button id="stop-btn" class="btn btn-danger control-btn">
                                <i class="fas fa-stop"></i> Stop System
                            </button>
                            <button id="home-btn" class="btn btn-warning control-btn">
                                <i class="fas fa-home"></i> Home Arm
                            </button>
                            <button id="calibrate-btn" class="btn btn-info control-btn">
                                <i class="fas fa-crosshairs"></i> Calibrate
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <!-- Camera Feed -->
            <div class="col-md-8">
                <div class="card status-card">
                    <div class="card-header bg-dark text-white">
                        <h5><i class="fas fa-camera"></i> Camera Feed</h5>
                    </div>
                    <div class="card-body">
                        <div class="camera-feed">
                            <img id="camera-feed" src="/api/camera/feed" alt="Camera Feed"
                                style="width: 100%; height: 300px; object-fit: cover;">
                        </div>
                        <div class="mt-2">
                            <button id="capture-btn" class="btn btn-primary">
                                <i class="fas fa-camera"></i> Capture Image
                            </button>
                            <button id="detect-btn" class="btn btn-secondary">
                                <i class="fas fa-search"></i> Run Detection
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- System Logs -->
            <div class="col-md-4">
                <div class="card status-card">
                    <div class="card-header bg-secondary text-white">
                        <h5><i class="fas fa-list"></i> System Logs</h5>
                    </div>
                    <div class="card-body">
                        <div id="log-container" class="log-container">
                            <div class="text-muted">Loading logs...</div>
                        </div>
                        <button id="refresh-logs-btn" class="btn btn-sm btn-outline-secondary mt-2">
                            <i class="fas fa-refresh"></i> Refresh
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Information -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card status-card">
                    <div class="card-header bg-info text-white">
                        <h5><i class="fas fa-info"></i> System Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <strong>Pi IP:</strong> <span id="pi-ip">Loading...</span>
                            </div>
                            <div class="col-md-3">
                                <strong>Uptime:</strong> <span id="uptime">Loading...</span>
                            </div>
                            <div class="col-md-3">
                                <strong>Temperature:</strong> <span id="temperature">Loading...</span>
                            </div>
                            <div class="col-md-3">
                                <strong>Memory:</strong> <span id="memory">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let statusInterval;
        let logInterval;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function () {
            updateStatus();
            updateLogs();
            getSystemInfo();

            // Set up intervals
            statusInterval = setInterval(updateStatus, 1000);
            logInterval = setInterval(updateLogs, 5000);

            // Set up event listeners
            setupEventListeners();
        });

        function setupEventListeners() {
            // Note: startSystem is now called via onclick on btn-start
            // document.getElementById('start-btn').addEventListener('click', startSystem); 
            document.getElementById('stop-btn').addEventListener('click', stopSystem);
            document.getElementById('home-btn').addEventListener('click', homeArm);
            document.getElementById('calibrate-btn').addEventListener('click', startCalibration);
            document.getElementById('capture-btn').addEventListener('click', captureImage);
            document.getElementById('detect-btn').addEventListener('click', runDetection);
            document.getElementById('refresh-logs-btn').addEventListener('click', updateLogs);

            // Auto Mode Toggle Listener
            document.getElementById('autoModeToggle').addEventListener('change', async function () {
                const isAuto = this.checked;
                const endpoint = isAuto ? '/api/auto/start' : '/api/auto/stop';

                try {
                    const response = await fetch(endpoint, { method: 'POST' });
                    const data = await response.json();

                    if (data.success) {
                        // Update UI immediately
                        updateUIForAutoMode(isAuto);
                    } else {
                        // Revert toggle if failed
                        this.checked = !isAuto;
                        showAlert('Failed to switch mode', 'danger');
                    }
                } catch (error) {
                    console.error('Error switching auto mode:', error);
                    this.checked = !isAuto;
                    showAlert('Error switching auto mode', 'danger');
                }
            });
        }

        async function updateStatus() {
            try {
                const response = await fetch('/pi/status');
                const status = await response.json();

                // Update status indicators
                document.getElementById('camera-status').textContent = status.camera_connected ? 'Connected' : 'Disconnected';
                document.getElementById('camera-status').className = status.camera_connected ? 'badge bg-success ms-2' : 'badge bg-danger ms-2';

                // Arduino status with connection type
                const arduinoStatus = document.getElementById('arduino-status');
                if (status.arduino_connected) {
                    const connType = status.connection_type || 'serial';
                    arduinoStatus.textContent = 'Connected (' + connType + ')';
                    arduinoStatus.className = 'badge bg-success ms-2';
                } else {
                    arduinoStatus.textContent = 'Disconnected';
                    arduinoStatus.className = 'badge bg-danger ms-2';
                }

                document.getElementById('model-status').textContent = status.classifier_loaded ? 'Loaded' : 'Not Loaded';
                document.getElementById('model-status').className = status.classifier_loaded ? 'badge bg-success ms-2' : 'badge bg-danger ms-2';

                document.getElementById('system-status').textContent = status.running ? 'Running' : 'Stopped';
                document.getElementById('system-status').className = status.running ? 'badge bg-success ms-2' : 'badge bg-danger ms-2';

                document.getElementById('detection-count').textContent = status.detection_count;
                document.getElementById('last-detection').textContent = status.last_detection || 'None';

                // Sync Auto Mode Toggle
                const autoToggle = document.getElementById('autoModeToggle');
                if (status.auto_mode !== undefined && autoToggle.checked !== status.auto_mode) {
                    autoToggle.checked = status.auto_mode;
                    updateUIForAutoMode(status.auto_mode);
                }

            } catch (error) {
                console.error('Error updating status:', error);
            }
            
            // Update Bluetooth status separately
            updateBluetoothStatus();
        }
        
        async function updateBluetoothStatus() {
            try {
                const response = await fetch('/api/bluetooth/status');
                const data = await response.json();
                const bluetoothStatus = document.getElementById('bluetooth-status');
                
                if (data.success && data.ble_connected) {
                    bluetoothStatus.textContent = 'Connected';
                    bluetoothStatus.className = 'badge bg-success ms-2';
                    if (data.ble_address) {
                        bluetoothStatus.title = 'Device: ' + data.ble_address;
                    }
                } else if (data.success && data.connected && data.connection_type === 'bluetooth') {
                    bluetoothStatus.textContent = 'Connecting...';
                    bluetoothStatus.className = 'badge bg-warning ms-2';
                } else {
                    bluetoothStatus.textContent = 'Disconnected';
                    bluetoothStatus.className = 'badge bg-danger ms-2';
                }
            } catch (error) {
                console.error('Error updating Bluetooth status:', error);
                const bluetoothStatus = document.getElementById('bluetooth-status');
                bluetoothStatus.textContent = 'Error';
                bluetoothStatus.className = 'badge bg-secondary ms-2';
            }
        }

        async function updateLogs() {
            try {
                const response = await fetch('/pi/logs');
                const data = await response.json();

                const logContainer = document.getElementById('log-container');
                logContainer.innerHTML = data.logs.map(log =>
                    `<div class="log-entry">${log}</div>`
                ).join('');

                // Scroll to bottom
                logContainer.scrollTop = logContainer.scrollHeight;

            } catch (error) {
                console.error('Error updating logs:', error);
            }
        }

        async function getSystemInfo() {
            try {
                // Get Pi IP
                const response = await fetch('/api/system/info');
                const info = await response.json();
                document.getElementById('pi-ip').textContent = info.ip || 'Unknown';
                document.getElementById('uptime').textContent = info.uptime || 'Unknown';
                document.getElementById('temperature').textContent = info.temperature || 'Unknown';
                document.getElementById('memory').textContent = info.memory || 'Unknown';
            } catch (error) {
                console.error('Error getting system info:', error);
            }
        }

        async function startSystem() {
            try {
                const response = await fetch('/api/system/start', { method: 'POST' });
                const result = await response.json();
                showAlert(result.message, 'success');
            } catch (error) {
                showAlert('Error starting system', 'danger');
            }
        }

        async function stopSystem() {
            try {
                const response = await fetch('/api/system/stop', { method: 'POST' });
                const result = await response.json();
                showAlert(result.message, 'warning');
            } catch (error) {
                showAlert('Error stopping system', 'danger');
            }
        }

        async function homeArm() {
            try {
                const response = await fetch('/api/arm/home', { method: 'POST' });
                const result = await response.json();
                showAlert(result.message, 'info');
            } catch (error) {
                showAlert('Error homing arm', 'danger');
            }
        }

        async function startCalibration() {
            try {
                const response = await fetch('/pi/control/calibrate');
                const result = await response.json();
                showAlert(result.message, 'info');
            } catch (error) {
                showAlert('Error starting calibration', 'danger');
            }
        }

        async function captureImage() {
            try {
                const response = await fetch('/api/camera/capture', { method: 'POST' });
                const result = await response.json();
                showAlert(result.message, 'success');
            } catch (error) {
                showAlert('Error capturing image', 'danger');
            }
        }

        async function runDetection() {
            try {
                const response = await fetch('/api/detection/run', { method: 'POST' });
                const result = await response.json();
                showAlert(result.message, 'success');
            } catch (error) {
                showAlert('Error running detection', 'danger');
            }
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            document.body.insertBefore(alertDiv, document.body.firstChild);

            // Auto-dismiss after 3 seconds
            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        }
    </script>
</body>

</html>